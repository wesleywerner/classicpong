<html>
    <head>
    <title>classic pong</title>
    <style type="text/css">
        body {
            background: #000;
            font-family: 'monospace';
            margin: 0px;
        }
        #zone {
            width: 640px;
            height: 480px;
            border: solid 1px #0f0;
        }
        #header {
            height: 200px;
            color: #00ff00;
            text-align: center;
            font-size: 42px;
            margin-top: 50px;
            background: url('assets/logo.png') no-repeat center top;
        }
        #footer {
            color: #003300;
            text-align: center;
            padding-top: 15px;
        }
        #footer a {
            color: #004400;
        }
        .center {
            margin-left: auto;
            margin-right: auto;
        }
    </style>
</head>

<script src="js/phaser.min.js"></script>
<script type="text/javascript">
    
    // constants
    var DEFAULT_BALL_SPEED = 150;
    var MARGIN = 25;
    var MAX_SCORE = 5;
    var BALL_SPEED_INCREASE_TIMER = 10;
    
    // variables
    var ballReleased = false;
    var isMultiplayer = false;
    var isGameOver = true;
    var batSpeed = 200;
    var ballSpeed = DEFAULT_BALL_SPEED;
    var ball;
    var backgroundImage;
    var increase_count = 0;
    
    // effects
    var ballHitEmitter;
    var ballDestroyEmitter;
    var smallBlipSound;
    var bigBlipsound;
    var ballDestroySound;
    
    // text objects
    var leftScoreText;
    var rightScoreText;
    var winText;
    var noticeText;
    
    // phaser game instance
    var game = new Phaser.Game(640, 480, Phaser.CANVAS, 'zone',
        { preload: onPreload, create: onCreate, update: onUpdate }
        );
    
    // player objects
    var leftPlayer;
    var rightPlayer;

    function createPlayer(paddleXPosition, upKey, downKey)
    {
        var newPlayer = {};
        newPlayer.score = 0;
        newPlayer.targetY = null;
        newPlayer.wins = 0;
        newPlayer.upKey = upKey;
        newPlayer.downKey = downKey;
        newPlayer.paddle = createPaddle(paddleXPosition, game.world.centerY / 2);
        return newPlayer;
    }
    
    function onPreload() 
    {
        game.load.image('bat', 'assets/bat.png');
        game.load.image('ball', 'assets/ball.png');
        game.load.image('background', 'assets/background.png');
        game.load.image('help', 'assets/help.png');
        game.load.image('particle', 'assets/particle.png');
        game.load.image('number0', 'assets/number0.png');
        game.load.image('number1', 'assets/number1.png');
        game.load.audio('small-blip', 'assets/small-blip.wav');
        game.load.audio('big-blip', 'assets/big-blip.wav');
        game.load.audio('destroy', 'assets/ball-destroy.wav');
    }
    
    function onCreate() 
    {
        game.add.sprite(0, 0, 'help');
        backgroundImage = game.add.tileSprite(0, 0, 640, 480, 'background');

        leftPlayer = createPlayer(MARGIN, Phaser.Keyboard.UP, Phaser.Keyboard.DOWN);
        rightPlayer = createPlayer(game.world.width - MARGIN, Phaser.Keyboard.W, Phaser.Keyboard.S);

        leftScoreText = game.add.text(240, 16, '0', { font: '60px monospace', fill: '#fff' });
        rightScoreText = game.add.text(360, 16, '0', { font: '60px monospace', fill: '#fff' });
        winText = game.add.text(140, game.world.height - 50,
            '', { font: '30px monospace', fill: '#0ff' });
        noticeText = game.add.text(
            MARGIN, game.world.height - MARGIN, 
            'tap or spacebar to play...', 
            { font: '20px monospace', fill: '#fff' });
        gameOver();
        resetBall();
        
        // hook into pointer down events for mouse click / touch movement
        game.input.onDown.add(touchScreen, this);
        
        // a timer increases the ball speed while playing.
        game.time.events.loop(Phaser.Timer.SECOND * BALL_SPEED_INCREASE_TIMER, speedUpBall, this);
        
        // particle effect
        ballHitEmitter = game.add.emitter(0, 0, 20);
        ballHitEmitter.gravity = 0;
        ballHitEmitter.makeParticles('particle');
        ballDestroyEmitter = game.add.emitter(0, 0, 20);
        ballDestroyEmitter.gravity = 0;
        ballDestroyEmitter.makeParticles(['particle', 'number0', 'number1']);
        ballDestroyEmitter.minParticleSpeed.setTo(-400, -400);
        ballDestroyEmitter.maxParticleSpeed.setTo(400, 400);
        
        smallBlipSound = game.add.audio('small-blip', 1, false);
        bigBlipSound = game.add.audio('big-blip', 1, false);
        ballDestroySound = game.add.audio('destroy', 1, false);
    }
    
    function touchScreen()
    {

        if (game.input.x < (game.world.width / 2))
        {
            // left side touch
            if (!isGameOver)
            {
                // start a new game
                if (!releaseBall())
                {
                    leftPlayer.targetY = game.input.y;
                }
            }
            else
            {
                // start single player game
                isMultiplayer = false;
                resetGame();
                resetBall();
            }
        }
        else
        {
            // right side touch
            if (!isGameOver)
            {
                // start a new game
                if (!releaseBall())
                {
                    rightPlayer.targetY = game.input.y;
                }
            }
            else
            {
                // start multiplayer game
                isMultiplayer = true;
                resetGame();
                resetBall();
            }
        }
    }
    
    function onUpdate()
    {
        
        if (game.input.keyboard.isDown(Phaser.Keyboard.SPACEBAR))
        {
            if (!isGameOver)
            {
                releaseBall();
            }
        }

        if (!isGameOver)
        {
        
            movePlayerPaddle(leftPlayer);
            if (isMultiplayer)
            {
                movePlayerPaddle(rightPlayer);
            }
            else
            {
                moveComputerPaddle(rightPlayer.paddle);
            }
            
            // process collisions
            game.physics.collide(ball, leftPlayer.paddle);
            game.physics.collide(ball, rightPlayer.paddle);
            
            if (ball.body.velocity.y == 0)
            {
                ball.body.velocity.y = 2 * Math.random() * 8;
            }
            
            if (ball.body.touching.left || ball.body.touching.right)
            {
                bigBlipSound.play('', 0, 1, false, true);
                if (increase_count > 3)
                {
                    ballHitEmitter.x = ball.x
                    ballHitEmitter.y = ball.y
                    ballHitEmitter.start(true, 4000, null, 2 * increase_count);
                }
            }
            
            if (ball.y < 8 || ball.y > 472)
            {
                smallBlipSound.play('', 0, 1, false, false);
            }
            
            // win test
            checkGoal();
            
        }
    }
    
    function movePlayerPaddle(playerObject)
    {
        if (game.input.keyboard.isDown(playerObject.upKey))
        {
            // the up key for this player is pressed
            playerObject.paddle.body.velocity.y = -batSpeed;
            playerObject.targetY = null;
        }
        else if (game.input.keyboard.isDown(playerObject.downKey))
        {
            // the down key for this player is pressed
            playerObject.paddle.body.velocity.y = batSpeed;
            playerObject.targetY = null;
        }
        else if (playerObject.targetY)
        {
            // the paddle has a target Y-position set
            var diff = (playerObject.targetY - playerObject.paddle.y);
            if (Math.abs(diff) > 15)
            {
                // move towards the target position
                var negative = diff < 0 ? -1 : 1;
                playerObject.paddle.body.velocity.y = negative * batSpeed;
            }
            else
            {
                // we reached the target position
                playerObject.targetY = null;
                playerObject.paddle.body.velocity.y = 0;
            }
        }
        else
        {
            // paddle should stop moving
            playerObject.paddle.body.velocity.y = 0;
        }
    }
    
    function moveComputerPaddle(paddleObject)
    {
        // track the vertical difference with the ball
        var pcDiff = (ball.y - paddleObject.y);
        
        // if the ball is coming our way
        if (ball.body.velocity.x > 1 && ball.x > 240)
        {
            if (Math.abs(pcDiff) > 20)
            {
                paddleObject.body.velocity.y = batSpeed * (pcDiff < 1 ? -1 : 1);
                //rightPaddle.body.velocity.y = (pcDiff * 8);
            }
        }
        else 
        {
            // ease the paddle into center position
            var toMiddle = 240 - paddleObject.y;
            paddleObject.body.velocity.y = toMiddle * 0.75;
        }
    }

    function createPaddle(x, y)
    {
        var bat = game.add.sprite(x, y, 'bat');
        bat.anchor.setTo(0.5, 0.5);
        bat.body.collideWorldBounds = true;
        bat.body.immovable = true;
        return bat;
    }
    
    function gameOver()
    {
        isGameOver = true;
        backgroundImage.visible = false;
        leftPlayer.paddle.visible = false;
        rightPlayer.paddle.visible = false;
        leftScoreText.visible = false;
        rightScoreText.visible = false;
        noticeText.visible = false;
        
        if (leftPlayer.score > rightPlayer.score)
        {
            winText.content = 'left wins!';
        }
        else if (rightPlayer.score > leftPlayer.score)
        {
            winText.content = 'right wins!';
        }
        else
        {
            winText.content = '';
        }
        
        winText.visible = true;
        resetBall();
    }
    
    function resetGame()
    {
        leftPlayer.score = 0;
        rightPlayer.score = 0;
        isGameOver = false;
        backgroundImage.visible = true;
        leftPlayer.paddle.visible = true;
        rightPlayer.paddle.visible = true;
        leftScoreText.visible = true;
        rightScoreText.visible = true;
        winText.visible = false;
        noticeText.visible = true;
    }
    
    function resetBall()
    {
        if (!ball)
        {
            ball = game.add.sprite(0, 0, 'ball');
            ball.anchor.setTo(0.5, 0.5);
            ball.body.collideWorldBounds = true;
            ball.body.bounce.setTo(1, 1);
            ball.body.maxVelocity = { x: 500, y: 200 };
        }
        
        if (isGameOver)
        {
            ball.body.velocity.x = Math.random() * 100;
            ball.body.velocity.y = Math.random() * 50;
        }
        else
        {
            ball.body.velocity.x = 0;
            ball.body.velocity.y = 0;
        }
        
        increase_count = 0;
        ballSpeed = DEFAULT_BALL_SPEED;
        ball.x = game.world.centerX;
        ball.y = game.world.centerY;
        ballReleased = false;
    }
    
    function releaseBall()
    {
        if (!ballReleased)
        {
            noticeText.visible = false;
            ball.body.velocity.x = ballSpeed * randomNeg();
            ball.body.velocity.y = Math.random() * ballSpeed * randomNeg();
            ballReleased = true;
            return true;
        }
    }
    
    function randomNeg()
    {
        if (Math.random() < 0.5)
        {
            return -1;
        }
        else
        {
            return 1;
        }
    }

    function speedUpBall()
    {
        if (!isGameOver && ballReleased)
        {
            increase_count++;
            if (ball.body.velocity.x < 0)
            {
                ball.body.velocity.x -= 35;
            }
            else
            {
                ball.body.velocity.x += 35;
            }
        }
    }
    
    function checkGoal()
    {
        if (!isGameOver)
        {
            if (ball.x < MARGIN)
            {
                ballDestroySound.play('', 0, 1, false, true);
                ballDestroyEmitter.x = ball.x
                ballDestroyEmitter.y = ball.y
                ballDestroyEmitter.start(true, 4000, null, 30);
                rightPlayer.score += 1;
                rightScoreText.content = rightPlayer.score;
                resetBall();
            }
            else if (ball.x > game.world.width - MARGIN)
            {
                ballDestroySound.play('', 0, 1, false, true);
                ballDestroyEmitter.x = ball.x
                ballDestroyEmitter.y = ball.y
                ballDestroyEmitter.start(true, 4000, null, 30);
                leftPlayer.score += 1;
                leftScoreText.content = leftPlayer.score;
                resetBall();
            }
            
            if (leftPlayer.score == MAX_SCORE || rightPlayer.score == MAX_SCORE)
            {
                gameOver();
            }
        }
    }
        
</script>

<body>
    <div id="header">classic pong</div>
    <div id="zone" class="center"></div>
    <div id="footer">created with <a href="http://phaser.io/">Phaser</a>. wesley 2014.</div>
</body>

</html>
